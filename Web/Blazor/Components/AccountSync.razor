@using System.Globalization
@using Microsoft.EntityFrameworkCore
@using SyncIT.Sync
@using SyncIT.Sync.Models
@using SyncIT.Sync.Services
@using SyncIT.Sync.Services.GSuite
@using SyncIT.Sync.Services.Json
@using SyncIT.Web.Blazor.Components.ChangeDisplay
@using SyncIT.Web.Database
@using SyncIT.Web.Database.Models.Services
@inject SyncItContext Db
@inject IServiceProvider ServiceProvider
@inject ILogger<AccountSync> Logger
@inject IDialogService DialogService
@inject ChangeResolver ChangeResolver
@rendermode InteractiveServer



<MudCard Elevation="0" Class="mb-4">
    <MudCardContent>
        <MudStack Spacing="2">
            <MudText Typo="Typo.body1">
                Review computed user and group changes between a chosen source and target.
                Select the changes you want to apply and press Apply.
            </MudText>

            <MudPaper Elevation="0" Class="pa-3">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudSelect T="Source" @bind-Value="_selectedSource" Margin="Margin.Dense"
                                       Variant="Variant.Outlined" Label="Account source" Class="w-100"
                                       Placeholder="Select account source"
                                       SelectedValuesChanged="@(() => UpdateChangesLists())">
                                @foreach (var source in _sources)
                                {
                                    <MudSelectItem T="Source" Value="@source">@source.BaseConfig.Name</MudSelectItem>
                                }
                            </MudSelect>
                            <MudSelect T="Target" @bind-Value="_selectedTarget" Margin="Margin.Dense"
                                       Variant="Variant.Outlined" Label="Account target" Class="w-100"
                                       Placeholder="Select account target"
                                       SelectedValuesChanged="@(() => UpdateChangesLists())"
                                       Style="flex: 1; min-width: 0;">
                                @foreach (var target in _targets)
                                {
                                    <MudSelectItem T="Target" Value="@target">@target.BaseConfig.Name</MudSelectItem>
                                }
                            </MudSelect>

                            <MudText
                                Style="@(_selectedTarget?.TargetService is GSuiteAccountService ? "" : "display: none;")"
                                Typo="Typo.caption" Color="Color.Info">
                                Note: When using G Suite as target, some changes may take longer to appear due to G
                                Suite caching.
                                So after applying changes, it may take some time before refreshing the changes list
                                shows the updated state.
                                Sometimes G Suite can also get in an inconsistent state with groups and memberships,
                                which may require manual intervention in the G Suite admin console.
                            </MudText>

                            <MudButton Color="Color.Info" Variant="Variant.Filled" Size="Size.Medium"
                                       Class="w-100"
                                       OnClick="@(() => UpdateChangesLists(true))"
                                       Disabled="@(_applyingChanges)">
                                Refresh
                                <MudIcon Icon="@Icons.Material.Filled.Refresh"/>
                            </MudButton>
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">

                            <MudPaper Elevation="1" Class="pa-3">
                                <MudText Typo="Typo.subtitle2">Summary</MudText>
                                <MudGrid>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2"><strong>Users</strong></MudText>
                                        <MudText Typo="Typo.caption">
                                            Add: @UserAdditions (@SelectedUserAdditions selected)
                                        </MudText>
                                        <br/>
                                        <MudText Typo="Typo.caption">Upd: @UserUpdates (@SelectedUserUpdates selected)
                                        </MudText>
                                        <br/>
                                        <MudText Typo="Typo.caption">
                                            Del: @UserDeletions (@SelectedUserDeletions selected)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudText Typo="Typo.body2"><strong>Groups</strong></MudText>
                                        <MudText Typo="Typo.caption">
                                            Add: @GroupAdditions (@SelectedGroupAdditions selected)
                                        </MudText>
                                        <br/>
                                        <MudText Typo="Typo.caption">
                                            Upd: @GroupUpdates (@SelectedGroupUpdates selected)
                                        </MudText>
                                        <br/>
                                        <MudText Typo="Typo.caption">
                                            Del: @GroupDeletions (@SelectedGroupDeletions selected)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12" Class="mt-2">
                                        <MudText Typo="Typo.caption">Selected: @_selectedUserChanges.Count users
                                            / @_selectedGroupChanges.Count groups
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12" Class="mt-2">
                                        <MudText Typo="Typo.caption">Source last
                                            used: @(_selectedSource?.BaseConfig.LastUsedAsSource?.ToLocalTime().ToString(CultureInfo.GetCultureInfo("SE")) ?? "Never")</MudText>
                                        <br/>
                                        <MudText Typo="Typo.caption">Target last
                                            used: @(_selectedTarget?.BaseConfig.LastUsedAsTarget?.ToLocalTime().ToString(CultureInfo.GetCultureInfo("SE")) ?? "Never")</MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>

                            <MudStack>
                                <MudButton Color="Color.Success" Variant="Variant.Filled" Size="Size.Medium"
                                           Class="w-100"
                                           OnClick="@ApplyChangesAsync"
                                           Disabled="@((_selectedUserChanges.Count == 0 && _selectedGroupChanges.Count == 0) || _applyingChanges)">
                                    Apply changes
                                    <MudIcon Icon="@Icons.Material.Filled.Upload"/>
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudStack>
    </MudCardContent>
</MudCard>


@{
    var userTabTitle = $"Users ({_selectedUserChanges.Count} / {_userChanges.Count})";
    var groupTabTitle = $"Groups ({_selectedGroupChanges.Count} / {_groupChanges.Count})";
}

<MudProgressLinear Indeterminate="true" Style=@(_showLoading ? "" : "display: none")></MudProgressLinear>
<MudTabs Elevation="2" Rounded="true" KeepPanelsAlive="true">
    <MudTabPanel Text="@userTabTitle">
        <MudDataGrid T="UserChange" @ref="_userChangeDataGrid" Items="@_userChanges" MultiSelection="true"
                     @bind-SelectedItems="@_selectedUserChanges">
            <Columns>
                <SelectColumn T="UserChange"></SelectColumn>
                <TemplateColumn Title="CID">
                    <CellTemplate>
                        <StringChange Before="@context.Item?.Before?.Cid" After="@context.Item?.After?.Cid"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Email">
                    <CellTemplate>
                        <StringChange Before="@context.Item?.Before?.Email" After="@context.Item?.After?.Email"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="First Name">
                    <CellTemplate>
                        <StringChange Before="@context.Item?.Before?.FirstName"
                                      After="@context.Item?.After?.FirstName"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Nick">
                    <CellTemplate>
                        <StringChange Before="@context.Item?.Before?.Nick" After="@context.Item?.After?.Nick"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Last Name">
                    <CellTemplate>
                        <StringChange Before="@context.Item?.Before?.LastName"
                                      After="@context.Item?.After?.LastName"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Aliases">
                    <CellTemplate>
                        <EmailSetChange Before="@context.Item?.Before?.Aliases"
                                        After="@context.Item?.After?.Aliases"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Recovery Email">
                    <CellTemplate>
                        <StringChange Before="@context.Item?.Before?.RecoveryEmail"
                                      After="@context.Item?.After?.RecoveryEmail"/>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudTabPanel>
    <MudTabPanel Text="@groupTabTitle">
        <MudDataGrid T="GroupChange" @ref="_groupChangeDataGrid" Items="@_groupChanges" MultiSelection="true"
                     @bind-SelectedItems="@_selectedGroupChanges">
            <Columns>
                <SelectColumn T="GroupChange"></SelectColumn>
                <TemplateColumn Title="Email">
                    <CellTemplate>
                        <StringChange Before="@context.Item?.Before?.Email" After="@context.Item?.After?.Email"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Aliases">
                    <CellTemplate>
                        <EmailSetChange Before="@context.Item?.Before?.Aliases"
                                        After="@context.Item?.After?.Aliases"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Name">
                    <CellTemplate>
                        <StringChange Before="@context.Item?.Before?.Name" After="@context.Item?.After?.Name"/>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Members">
                    <CellTemplate>
                        <EmailSetChange Before="@context.Item?.Before?.Members"
                                        After="@context.Item?.After?.Members"/>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    </MudTabPanel>
</MudTabs>

<MudDialog @ref="_progressDialog" Style="width: 800px" OnBackdropClick="() => { }">

    <TitleContent>
        <MudText Typo="Typo.h5">Applying Changes</MudText>
    </TitleContent>

    <DialogContent>
        @if (_userProgressMax > 0)
        {
            <MudText Typo="Typo.body1">User changes</MudText>
            <MudProgressLinear Color="Color.Primary" Style="margin-bottom: 10px;" Value="@_userProgressValue"
                               Max="_userProgressMax"/>
            @if (_failedUserChanges.Count > 0)
            {
                <MudText Typo="Typo.body2" Color="Color.Error">Failed to apply @_failedUserChanges.Count user
                    changes
                </MudText>
            }
        }
        @if (_groupProgressMax > 0)
        {
            <MudText Typo="Typo.body1">Group changes</MudText>
            <MudProgressLinear Color="Color.Primary" Style="margin-bottom: 10px;" Value="@_groupProgressValue"
                               Max="_groupProgressMax"/>
            @if (_failedGroupChanges.Count > 0)
            {
                <MudText Typo="Typo.body2" Color="Color.Error">Failed to apply @_failedGroupChanges.Count group
                    changes
                </MudText>
            }
        }

    </DialogContent>

    <DialogActions>
        <MudButton
            Disabled="@(_applyingChanges | (_failedGroupChanges.Count == 0 && _failedUserChanges.Count == 0))"
            OnClick="@ShowErrorAndHideProgressDialog">
            Show errors
        </MudButton>
        <MudButton Disabled="@_applyingChanges" OnClick="HideProgressDialog">
            Done
        </MudButton>
    </DialogActions>

</MudDialog>

<MudDialog @ref="_errorDisplayDialog">
    <TitleContent>
        <MudText Typo="Typo.h5">Failed Changes</MudText>
    </TitleContent>
    <DialogContent>
        @if (_failedUserChanges.Count > 0)
        {
            <MudText Typo="Typo.body1">Failed User Changes</MudText>
            <MudDataGrid T="UserChangeResult" Items="_failedUserChanges">
                <Columns>
                    <TemplateColumn Title="Email">
                        <CellTemplate>
                            <MudText>@((context.Item.UserChange.After ?? context.Item.UserChange.Before)?.Email)</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Exception">
                        <CellTemplate>
                            <MudText>@context.Item.Exception?.Message</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        }

        @if (_failedGroupChanges.Count > 0)
        {
            <MudText Typo="Typo.body1">Failed Group Changes</MudText>
            <MudDataGrid T="GroupChangeResult" Items="_failedGroupChanges">
                <Columns>
                    <TemplateColumn Title="Change ID">
                        <CellTemplate>
                            <MudText>@((context.Item.GroupChange.After ?? context.Item.GroupChange.Before)?.Email)</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Exception">
                        <CellTemplate>
                            <MudText>@context.Item.Exception?.Message</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        }
        <MudText>
            For more information check the logs.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HideErrorDisplayDialog">
            Close
        </MudButton>
    </DialogActions>
</MudDialog>


@code {

    private bool _showLoading;
    private bool _applyingChanges;

    private MudDialog _progressDialog = null!;
    private MudDialog _errorDisplayDialog = null!;
    private int _userProgressValue;
    private int _groupProgressValue;
    private int _userProgressMax;
    private int _groupProgressMax;

    private MudDataGrid<UserChange> _userChangeDataGrid = null!;
    private MudDataGrid<GroupChange> _groupChangeDataGrid = null!;

    private Target? _selectedTarget;
    private Source? _selectedSource;

    private List<Target> _targets = [];
    private List<Source> _sources = [];

    private List<UserChange> _userChanges = [];
    private List<GroupChange> _groupChanges = [];

    private HashSet<UserChange> _selectedUserChanges = [];
    private HashSet<GroupChange> _selectedGroupChanges = [];

    private List<AdditionalUser> _additionalUsers = new();
    private List<AdditionalGroup> _additionalGroups = new();

    private readonly List<UserChangeResult> _failedUserChanges = new();
    private readonly List<GroupChangeResult> _failedGroupChanges = new();

    // Computed summary counts for the UI
    private int UserAdditions => _userChanges.Count(x => x.After is not null && x.Before is null);
    private int UserUpdates => _userChanges.Count(x => x.After is not null && x.Before is not null);
    private int UserDeletions => _userChanges.Count(x => x.After is null && x.Before is not null);

    private int GroupAdditions => _groupChanges.Count(x => x.After is not null && x.Before is null);
    private int GroupUpdates => _groupChanges.Count(x => x.After is not null && x.Before is not null);
    private int GroupDeletions => _groupChanges.Count(x => x.After is null && x.Before is not null);

    // Selected vs available counts
    private int SelectedUserAdditions => _selectedUserChanges.Count(x => x.After is not null && x.Before is null);
    private int SelectedUserUpdates => _selectedUserChanges.Count(x => x.After is not null && x.Before is not null);
    private int SelectedUserDeletions => _selectedUserChanges.Count(x => x.After is null && x.Before is not null);

    private int SelectedGroupAdditions => _selectedGroupChanges.Count(x => x.After is not null && x.Before is null);
    private int SelectedGroupUpdates => _selectedGroupChanges.Count(x => x.After is not null && x.Before is not null);
    private int SelectedGroupDeletions => _selectedGroupChanges.Count(x => x.After is null && x.Before is not null);

    private async Task ShowProgressDialog()
    {
        await _progressDialog.ShowAsync();
    }

    private async Task HideProgressDialog()
    {
        await _progressDialog.CloseAsync();
    }

    private async Task ShowErrorAndHideProgressDialog()
    {
        await HideProgressDialog();
        await _errorDisplayDialog.ShowAsync();
    }

    private async Task HideErrorDisplayDialog()
    {
        await _errorDisplayDialog.CloseAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var allTargetsAndSources = await Db.BaseSyncServiceConfigs.Select(x =>
                new { Config = x, Source = x.ToSource(ServiceProvider) }).ToListAsync();

            _targets = allTargetsAndSources.Where(x => x.Config.CanBeTarget && x.Source is ITarget)
                .OrderByDescending(x => x.Config.LastUsedAsTarget)
                .Select(x => new Target(x.Config, (ITarget)x.Source))
                .ToList();

            _additionalUsers = await Db.AdditionalUsers.Select(u => u.ToAdditionalUser()).ToListAsync();
            _additionalGroups = await Db.AdditionalGroups.Select(g => g.ToAdditionalGroup()).ToListAsync();


            _sources = allTargetsAndSources
                .OrderByDescending(x => x.Config.LastUsedAsSource)
                .Select(x => new Source(x.Config, x.Source)).ToList();
        }
        catch (Exception e)
        {
            Logger.LogError(e, "Failed to load targets and sources");
            _ = DialogService.ShowMessageBox("Error", "Failed to load targets and sources.\n Check the logs and check source/target settings.");
        }

        _selectedSource = _sources.FirstOrDefault();
        _selectedTarget = _targets.FirstOrDefault();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UpdateChangesLists();
        }
    }

    private async Task UpdateChangesLists(bool clickTrigger = false)
    {
        if (_selectedTarget is null || _selectedSource is null)
        {
            if (clickTrigger)
                _ = DialogService.ShowMessageBox("Error", "Please select a target and a source");

            return;
        }

        _groupChanges.Clear();
        _userChanges.Clear();
        _selectedGroupChanges.Clear();
        _selectedUserChanges.Clear();
        _showLoading = true;
        StateHasChanged(); // Force update to show progress dialog

        try
        {
            var beforeUsersTask = _selectedTarget.TargetService.GetUsersAsync();
            var beforeGroupsTask = _selectedTarget.TargetService.GetGroupsAsync();
            var afterUsersTask = _selectedSource.SourceService.GetUsersAsync();
            var afterGroupsTask = _selectedSource.SourceService.GetGroupsAsync();

            await Task.WhenAll(beforeUsersTask, beforeGroupsTask, afterUsersTask, afterGroupsTask);

            var afterUsers = AdditionsMerger.MergeAdditionalUsers(afterUsersTask.Result, _additionalUsers);
            var afterGroups = AdditionsMerger.MergeAdditionalGroups(afterGroupsTask.Result, _additionalGroups);

            _userChanges = ChangeResolver.ResolveUserChanges(beforeUsersTask.Result, afterUsers);
            _groupChanges = ChangeResolver.ResolveGroupChanges(beforeGroupsTask.Result, afterGroups);
        }
        catch (Exception e)
        {
            Logger.LogError(e, "Failed to update changes lists");
            _ = DialogService.ShowMessageBox("Error", "Failed to update changes lists.\n Check the logs and check source/target settings.");
        }
        finally
        {
            _showLoading = false;
            StateHasChanged();
        }
    }

    private async Task ApplyChangesAsync()
    {
        if (_selectedTarget is null || _selectedSource is null)
        {
            return;
        }

        var userChangesToApply = _selectedUserChanges.Where(x => x.After is not null || x.Before is not null).ToList();
        var groupChangesToApply = _selectedGroupChanges.Where(x => x.After is not null || x.Before is not null).ToList();
        var target = _selectedTarget.TargetService;

        var userAdditionsCount = userChangesToApply.Count(x => x.After is not null && x.Before is null);
        var userDeletionsCount = userChangesToApply.Count(x => x.After is null && x.Before is not null);
        var userUpdatesCount = userChangesToApply.Count(x => x.After is not null && x.Before is not null);

        var groupAdditionsCount = groupChangesToApply.Count(x => x.After is not null && x.Before is null);
        var groupDeletionsCount = groupChangesToApply.Count(x => x.After is null && x.Before is not null);
        var groupUpdatesCount = groupChangesToApply.Count(x => x.After is not null && x.Before is not null);

        if (!(await DialogService.ShowMessageBox("Apply Changes",
                $"Are you sure you want to apply the following changes?\n" +
                $"Users: {userAdditionsCount} additions, {userDeletionsCount} deletions, {userUpdatesCount} updates\n" +
                $"Groups: {groupAdditionsCount} additions, {groupDeletionsCount} deletions, {groupUpdatesCount} updates",
                "Yes", cancelText: "No") ?? false))
        {
            return;
        }

        _applyingChanges = true;
        _userProgressMax = userChangesToApply.Count;
        _groupProgressMax = groupChangesToApply.Count;
        _userProgressValue = 0;
        _groupProgressValue = 0;
        _failedUserChanges.Clear();
        _failedGroupChanges.Clear();
        await ShowProgressDialog();
        StateHasChanged();

        var userChangeResults = ChangeApplier.ApplyUserChangesAsync(userChangesToApply, target);

        await foreach (var changeResult in userChangeResults)
        {
            if (changeResult.Exception is null)
            {
                Logger.LogInformation("Successfully applied user change: {Change}", changeResult.UserChange.ChangeId);
            }
            else
            {
                Logger.LogError(changeResult.Exception, "Failed to apply user change: {Change}", changeResult.UserChange.ChangeId);
                _failedUserChanges.Add(changeResult);
            }

            _userProgressValue++;
            StateHasChanged();
        }

        var groupChangeResults = ChangeApplier.ApplyGroupChangesAsync(groupChangesToApply, target);

        await foreach (var changeResult in groupChangeResults)
        {
            if (changeResult.Exception is null)
            {
                Logger.LogInformation("Successfully applied group change: {Change}", changeResult.GroupChange.ChangeId);
            }
            else
            {
                Logger.LogError(changeResult.Exception, "Failed to apply group change: {Change}", changeResult.GroupChange.ChangeId);
                _failedGroupChanges.Add(changeResult);
            }

            _groupProgressValue++;
            StateHasChanged();
        }

        switch (target)
        {
            case JsonAccountService jsonAccountService:
                await jsonAccountService.SaveAsync();
                break;
        }

        _applyingChanges = false;
        StateHasChanged();
        _selectedUserChanges.Clear();
        _selectedGroupChanges.Clear();

        _selectedSource.BaseConfig.LastUsedAsSource = DateTime.UtcNow;
        _selectedTarget.BaseConfig.LastUsedAsTarget = DateTime.UtcNow;
        await Db.SaveChangesAsync();

        await UpdateChangesLists();
    }

    private record Target(BaseSyncServiceConfig BaseConfig, ITarget TargetService);

    private record Source(BaseSyncServiceConfig BaseConfig, ISource SourceService);

    // Helper methods for the right-side preview
    private string GetUserChangeType(UserChange c)
    {
        if (c.Before is null && c.After is not null) return "Add";
        if (c.After is null && c.Before is not null) return "Delete";
        return "Update";
    }

    private string DisplayUserLabel(UserChange c)
    {
        var u = c.After ?? c.Before;
        return u?.Email ?? u?.Cid ?? "(unknown)";
    }

    private string GetGroupChangeType(GroupChange c)
    {
        if (c.Before is null && c.After is not null) return "Add";
        if (c.After is null && c.Before is not null) return "Delete";
        return "Update";
    }

    private string DisplayGroupLabel(GroupChange c)
    {
        var g = c.After ?? c.Before;
        return g?.Email ?? g?.Name ?? "(unknown)";
    }

}
