@using SyncIT.Sync.Models
@if (Emails is not null)
{
    <MudChipSet T="EmailAddress" Variant="Variant.Text" AllClosable OnClose="Remove">
        @foreach (var email in Emails)
        {
            <MudChip Value="email" Text="@email.Email"/>
        }
    </MudChipSet>
    <MudButton StartIcon="@Icons.Material.Filled.Add" OnClick="ShowAddDialog">Add @NameOfItem</MudButton>
}

<MudDialog @ref="_addDialog">
    <TitleContent>
        <MudText Typo="Typo.h5">Add @NameOfItem</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @bind-IsValid="_isEmailValid">
            <MudInputString @bind-Value="_emailInput" Required="true" Validation="@Validate" Immediate="true"/>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HideAddDialog">
            Cancel
        </MudButton>
        <MudButton OnClick="Add" Disabled="@(!_isEmailValid)">
            Add
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public ICollection<EmailAddress>? Emails { get; set; } = new HashSet<EmailAddress>();

    /// <summary>
    ///     The "name" of a item. Used for titles and alike.
    /// </summary>
    /// <remarks>
    ///     Defaults to
    ///     <code>Email</code>
    /// </remarks>
    [Parameter]
    public string NameOfItem { get; set; } = "Email";

    private MudDialog _addDialog = null!;
    private string _emailInput = string.Empty;
    private bool _isEmailValid = false;

    private Func<string?, string?> Validate => x => x is not null && EmailAddress.IsValid(x) ? null : "Invalid email address";

    private async Task ShowAddDialog()
    {
        await _addDialog.ShowAsync();
    }

    private async Task HideAddDialog()
    {
        await _addDialog.CloseAsync();
    }

    private void Add()
    {
        if (!EmailAddress.IsValid(_emailInput))
        {
            return;
        }

        if (Emails is not null)
        {
            var email = new EmailAddress(_emailInput);
            if (!Emails.Contains(email, EmailAddress.EmailComparer))
            {
                Emails.Add(email);
            }
        }

        _emailInput = string.Empty;
        _ = HideAddDialog();
    }

    private void Remove(MudChip<EmailAddress> chip)
    {
        if (Emails is null || chip.Value is null)
        {
            return;
        }

        Emails.Remove(chip.Value);
    }

}